<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .check-icon {
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="container py-5" style="max-width: 500px;">
<header th:replace="~{fragments/header :: header}"></header>

<h2 class="mb-4 text-center">회원가입</h2>

<form id="registerForm" th:action="@{/register}" method="post" onsubmit="return validateForm()">
    <div class="mb-3">
        <label for="username" class="form-label">아이디</label>
        <div class="input-group">
            <input type="text" class="form-control" id="username" name="username" required>
            <span id="usernameIcon" class="check-icon"></span>
        </div>
    </div>

    <div class="mb-3">
        <label for="password" class="form-label">비밀번호</label>
        <input type="password" class="form-control" id="password" name="password" required>
    </div>

    <div class="mb-3">
        <label for="nickname" class="form-label">닉네임</label>
        <div class="input-group">
            <input type="text" class="form-control" id="nickname" name="nickname" required>
            <span id="nicknameIcon" class="check-icon"></span>
        </div>
    </div>

    <button type="submit" id="submitBtn" class="btn btn-primary w-100" disabled>가입하기</button>
</form>

<!-- 메시지 박스 -->
<div id="messageBox" class="alert mt-4 d-none" role="alert"></div>

<script>
    let usernameChecked = false;
    let nicknameChecked = false;
    let usernameTimer = null;
    let nicknameTimer = null;

    function showMessage(message, isSuccess = true) {
        const box = document.getElementById("messageBox");
        box.className = "alert mt-4";
        box.classList.add(isSuccess ? "alert-success" : "alert-danger");
        box.textContent = message;
        box.classList.remove("d-none");
    }

    function setIcon(id, valid) {
        const el = document.getElementById(id);
        el.textContent = valid ? "✅" : "❌";
    }

    function updateSubmitButtonState() {
        const btn = document.getElementById("submitBtn");
        if (usernameChecked && nicknameChecked) {
            btn.disabled = false;
        } else {
            btn.disabled = true;
        }
    }

    function debounceCheckUsername() {
        clearTimeout(usernameTimer);
        usernameTimer = setTimeout(checkUsername, 500);
    }

    function debounceCheckNickname() {
        clearTimeout(nicknameTimer);
        nicknameTimer = setTimeout(checkNickname, 500);
    }

    function checkUsername() {
        const username = document.getElementById("username").value.trim();
        if (!username) {
            showMessage("아이디를 입력하세요", false);
            setIcon("usernameIcon", false);
            usernameChecked = false;
            updateSubmitButtonState();
            return;
        }

        fetch(`/check/username?username=${encodeURIComponent(username)}`)
            .then(res => res.json())
            .then(data => {
                if (data.available) {
                    showMessage("사용 가능한 아이디입니다.");
                    usernameChecked = true;
                    setIcon("usernameIcon", true);
                } else {
                    showMessage("이미 사용 중인 아이디입니다.", false);
                    usernameChecked = false;
                    setIcon("usernameIcon", false);
                }
                updateSubmitButtonState();
            });
    }

    function checkNickname() {
        const nickname = document.getElementById("nickname").value.trim();
        if (!nickname) {
            showMessage("닉네임을 입력하세요", false);
            setIcon("nicknameIcon", false);
            nicknameChecked = false;
            updateSubmitButtonState();
            return;
        }

        fetch(`/check/nickname?nickname=${encodeURIComponent(nickname)}`)
            .then(res => res.json())
            .then(data => {
                if (data.available) {
                    showMessage("사용 가능한 닉네임입니다.");
                    nicknameChecked = true;
                    setIcon("nicknameIcon", true);
                } else {
                    showMessage("이미 사용 중인 닉네임입니다.", false);
                    nicknameChecked = false;
                    setIcon("nicknameIcon", false);
                }
                updateSubmitButtonState();
            });
    }

    function validateForm() {
        if (!usernameChecked || !nicknameChecked) {
            showMessage("아이디와 닉네임 중복검사를 통과해야 합니다.", false);
            return false;
        }
        return true;
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("username").addEventListener("input", () => {
            usernameChecked = false;
            setIcon("usernameIcon", false);
            debounceCheckUsername();
        });
        document.getElementById("nickname").addEventListener("input", () => {
            nicknameChecked = false;
            setIcon("nicknameIcon", false);
            debounceCheckNickname();
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<div class="mt-3 text-center">
    <a th:href="@{/login}">← 로그인 페이지로</a>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>
</body>
</html>
