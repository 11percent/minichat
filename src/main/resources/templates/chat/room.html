<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì±„íŒ…ë°©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-box {
            height: 500px;
            min-width: 350px;
            overflow-y: scroll;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            background-color: #f8f9fa;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 75%;
            margin-bottom: 1rem;
            word-break: break-word;
        }

        .chat-message.mine {
            align-self: flex-end;
            text-align: right;
        }

        .chat-message.mine .bubble {
            background-color: #007bff;
            color: white;
            border-radius: 1rem 1rem 0 1rem;
            padding: 0.5rem 1rem;
            display: inline-block;
        }

        .chat-message.other {
            align-self: flex-start;
            text-align: left;
        }

        .chat-message.other .bubble {
            background-color: #e4e6eb;
            color: #000;
            border-radius: 1rem 1rem 1rem 0;
            padding: 0.5rem 1rem;
            display: inline-block;
        }

        .sender {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .timestamp {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.25rem;
        }

        .chat-message .sender {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .chat-message .timestamp {
            font-size: 0.75rem;
            color: #888;
        }

        .chat-input-box {
            display: flex;
            gap: 0.5rem;
        }

        .bubble img {
            max-width: 100%; display: block;
        }
    </style>
</head>

<body class="container py-4">

<!-- ìƒë‹¨ ì˜ì—­: ì±„íŒ…ë°© ì œëª© + ì°¸ì—¬ì ìš°ì¸¡ ì •ë ¬ -->
<div class="d-flex justify-content-between align-items-center mb-2">
    <h3 class="fw-bold mb-0">ì±„íŒ…ë°©</h3>

    <div class="d-flex align-items-center gap-1 flex-wrap">
        <span class="fw-semibold me-1">ì°¸ì—¬ì</span>
        <div class="d-flex gap-1 flex-wrap">
            <span class="badge bg-light border text-dark"
                  th:each="member : ${roomMembers}"
                  th:text="${member.nickname}">ë‹‰ë„¤ì„</span>
        </div>
    </div>
</div>

<!-- ë‘ ë²ˆì§¸ ì¤„: ì´ˆëŒ€/ë‚˜ê°€ê¸° -->
<div class="d-flex justify-content-end align-items-center gap-2 mb-3 flex-wrap">
    <form th:action="@{/chat/room/{roomId}/invite(roomId=${roomId})}" method="post"
          class="d-flex gap-2 align-items-center">
        <input type="hidden" name="roomId" th:value="${roomId}"/>
        <input type="text" name="nickname" class="form-control form-control-sm" placeholder="ë‹‰ë„¤ì„ ì…ë ¥"
               style="width: 150px;" required/>
        <button type="submit" class="btn btn-success btn-sm">+ ì´ˆëŒ€</button>
    </form>
    <form th:action="@{/chat/room/{roomId}/leave(roomId=${roomId})}" method="post"
          onsubmit="return confirmLeaveRoom()">
        <button type="submit" class="btn btn-outline-danger btn-sm">ë‚˜ê°€ê¸°</button>
    </form>
</div>


<div class="chat-box" id="chatBox">
    <div th:each="msg : ${messages}"
         th:attr="id='msg-' + ${msg.id}"
         th:class="'chat-message ' + (${msg.senderId} == ${myId} ? 'mine' : 'other')">
        <div class="sender" th:text="${msg.senderNickname}">ë‹‰ë„¤ì„</div>

        <div class="bubble">
            <img th:if="${msg.imageUrl != null}" th:src="${msg.imageUrl}" alt="ì²¨ë¶€ ì´ë¯¸ì§€" style="max-width: 200px; border-radius: 8px;"/>
            <span th:if="${msg.imageUrl == null}" th:text="${msg.content}">ë©”ì‹œì§€ ë‚´ìš©</span>
        </div>

        <div class="timestamp">
            <span th:text="${msg.createdAt}">15:00</span>
            <span class="unread-count ms-1 text-primary small"
                  th:text="${msg.unreadCount > 0 ? msg.unreadCount : ''}">1</span>
        </div>
    </div>
</div>

<div class="chat-input-box align-items-start gap-2" style="position: relative;">
    <button type="button" id="emoji-button" class="btn btn-outline-secondary">ğŸ˜Š</button>

    <form th:action="@{/chat/message/send}" method="post" id="chatForm" class="d-flex flex-grow-1 gap-2">
        <input type="hidden" name="roomId" th:value="${roomId}" id="roomId"/>
        <input type="text" name="content" class="form-control"
               style="font-size: 16px;" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required id="chatInput"/>
        <button type="submit" class="btn btn-primary" style="font-size: 0.8rem; min-width: 60px;">ì „ì†¡</button>
    </form>
</div>

<div class="mt-2 d-flex align-items-center gap-2">
    <input type="file" id="imageInput" accept="image/*" class="form-control form-control-sm"
           style="max-width: 300px;"/>
    <button onclick="resizeAndUploadImage()">ì´ë¯¸ì§€ ì „ì†¡</button>
</div>

<div class="mt-3">
    <button class="btn btn-outline-secondary btn-sm" onclick="window.close()">ğŸ”šíŒì—…ì°½ ë„ê¸°</button>
</div>

<script>
    function confirmLeaveRoom() {
        return confirm("ì±„íŒ…ë°©ì—ì„œ ë‚˜ê°€ë©´ ë‹¤ì‹œ ì…ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?");
    }
</script>

<script src="/js/emoji-button.with-categories.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const trigger = document.getElementById("emoji-button");
        const input = document.getElementById("chatInput");

        const picker = new EmojiButton({
            position: 'bottom-start'
        });

        picker.on("emoji", emoji => {
            input.value += emoji;
            input.focus();
        });

        // í”¼ì»¤ ì—´ë¦´ ë•Œ ìŠ¤íƒ€ì¼ ì¡°ì •
        picker.on("picker:show", () => {
            const interval = setInterval(() => {
                const categoryButtons = document.querySelectorAll(".emoji-picker__category-button");
                if (categoryButtons.length > 0) {
                    categoryButtons.forEach(btn => {
                        btn.style.width = "26px";
                        btn.style.height = "26px";
                        btn.style.margin = "1px";
                        btn.style.padding = "0";
                    });
                    clearInterval(interval); // ìŠ¤íƒ€ì¼ ì ìš© ì™„ë£Œë˜ë©´ ì •ì§€
                }
            }, 50);
        });

        trigger.addEventListener("click", () => {
            picker.togglePicker(trigger);
        });
    });
</script>

<script th:inline="javascript">
    const myId = [[${myId}]];
    const roomId = [[${roomId}]];
</script>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<!-- WebSocket ì—°ê²° -->
<script>
    let stompClient;
    document.addEventListener("DOMContentLoaded", function () {
        const chatBox = document.getElementById("chatBox");
        const chatInput = document.getElementById("chatInput");
        const chatForm = document.getElementById("chatForm");

        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);
        scrollToBottomWhenImagesLoaded();


        stompClient.connect({}, function () {
            // âœ… ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ 
            stompClient.subscribe(`/topic/room/${roomId}`, function (messageOutput) {
                const msg = JSON.parse(messageOutput.body);
                console.log("ğŸ“© ìˆ˜ì‹ ëœ ë©”ì‹œì§€:", msg);
                const isMine = parseInt(msg.senderId) === parseInt(myId);

                const messageDiv = document.createElement("div");
                messageDiv.className = `chat-message ${isMine ? 'mine' : 'other'}`;
                messageDiv.id = `msg-${msg.id}`;

                const senderEl = document.createElement("div");
                senderEl.className = "sender";
                senderEl.textContent = msg.senderNickname;

                const bubbleEl = document.createElement("div");
                bubbleEl.className = "bubble";

                if (msg.type === "IMAGE" && msg.imageUrl) {
                    const imgEl = document.createElement("img");
                    imgEl.src = msg.imageUrl;
                    imgEl.alt = "ì²¨ë¶€ ì´ë¯¸ì§€";
                    imgEl.style.maxWidth = "200px";
                    imgEl.style.borderRadius = "8px";

                    // âœ… ì´ë¯¸ì§€ ë¡œë”© í›„ì— ìŠ¤í¬ë¡¤ ì´ë™
                    imgEl.onload = function () {
                        chatBox.scrollTop = chatBox.scrollHeight;
                    };

                    bubbleEl.appendChild(imgEl);
                } else if (msg.content) {
                    bubbleEl.textContent = msg.content;
                    chatBox.scrollTop = chatBox.scrollHeight; // í…ìŠ¤íŠ¸ëŠ” ë°”ë¡œ ì´ë™
                }

                const timestampEl = document.createElement("div");
                timestampEl.className = "timestamp";

                const timeSpan = document.createElement("span");
                timeSpan.textContent = msg.createdAt;

                const unreadSpan = document.createElement("span");
                unreadSpan.className = "unread-count ms-1 text-primary small";
                unreadSpan.textContent = msg.unreadCount > 0 ? msg.unreadCount : "";

                timestampEl.appendChild(timeSpan);
                timestampEl.appendChild(unreadSpan);

                messageDiv.appendChild(senderEl);
                messageDiv.appendChild(bubbleEl);
                messageDiv.appendChild(timestampEl);

                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;

                // âœ… ë Œë”ë§ í›„ì—ë§Œ ì½ìŒ ì²˜ë¦¬ (isMineì´ ì•„ë‹ ê²½ìš°)
                if (!isMine) {
                    setTimeout(() => {
                        stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify({
                            type: "READ",
                            senderId: myId,
                            lastReadMessageId: msg.id
                        }));
                    }, 100); // ì´ë¯¸ì§€ê°€ ì œëŒ€ë¡œ ë Œë”ë§ëœ í›„
                }

                if (window.opener && typeof window.opener.reloadChatRoomList === "function") {
                    window.opener.reloadChatRoomList();
                }
            });

            // âœ… ì½ìŒ ìˆ˜ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
            stompClient.subscribe(`/topic/room/${roomId}/read`, function (messageOutput) {
                try {
                    const update = JSON.parse(messageOutput.body);
                    console.log("ğŸ‘€ READ ìˆ˜ì‹ :", update);

                    if (update.type !== "READ") return;

                    // ì½ìŒ ëŒ€ìƒ ë©”ì‹œì§€ DOM íƒìƒ‰
                    const msgDiv = document.getElementById(`msg-${update.id}`);
                    if (msgDiv) {
                        const unreadSpan = msgDiv.querySelector(".unread-count");
                        if (unreadSpan) {
                            unreadSpan.textContent = update.unreadCount > 0 ? update.unreadCount : "";
                        } else {
                            console.warn("ğŸ” .unread-count spanì´ ì—†ìŒ");
                        }
                    } else {
                        console.warn("â— í•´ë‹¹ ë©”ì‹œì§€ DOM ìš”ì†Œ ì—†ìŒ:", update.id);
                    }

                } catch (e) {
                    console.error("âŒ READ ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", e);
                }
            });

            //  âœ… ì±„íŒ…ë°© ì…ì¥ ì‹œ â†’ ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ìš”ì²­ ì „ì†¡
            const messageEls = Array.from(document.querySelectorAll(".chat-message"));
            let lastReadMessageId = null;

            for (let i = messageEls.length - 1; i >= 0; i--) {
                const el = messageEls[i];
                if (!el.classList.contains("mine")) {
                    lastReadMessageId = el.id?.replace("msg-", "");
                    break;
                }
            }


            if (lastReadMessageId) {
                stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify({
                    type: "READ",
                    senderId: myId,
                    lastReadMessageId: parseInt(lastReadMessageId, 10) // âœ… ìˆ«ìë¡œ ë³€í™˜
                }));

                // âœ… ì½ìŒ ì²˜ë¦¬ í›„, ë¶€ëª¨ì°½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                if (window.opener && typeof window.opener.reloadChatRoomList === "function") {
                    window.opener.reloadChatRoomList();
                }
            }

            // âœ… ë©”ì‹œì§€ ì „ì†¡
            chatForm.addEventListener("submit", function (e) {
                e.preventDefault();

                const content = chatInput.value.trim();
                if (!content) return;

                stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify({
                    type: "MESSAGE",
                    senderId: myId,
                    senderNickname: "MJ",
                    content: content,
                    createdAt: new Date().toISOString()
                }));

                if (window.opener && typeof window.opener.reloadChatRoomList === "function") {
                    window.opener.reloadChatRoomList();
                }

                chatInput.value = "";
                chatInput.focus();
            });

            chatInput.focus();
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    });

    console.log("ë¶€ëª¨ì°½ì— reloadChatRoomList í˜¸ì¶œ");
</script>
<script>
    function resizeAndUploadImage() {
        const fileInput = document.getElementById("imageInput");
        const file = fileInput.files[0];

        if (!file) {
            alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const maxDimension = 800; // ìµœëŒ€ ê°€ë¡œ/ì„¸ë¡œ í¬ê¸°

        const img = new Image();
        img.src = URL.createObjectURL(file);

        img.onload = () => {
            const canvas = document.createElement("canvas");
            let width = img.width;
            let height = img.height;

            // ë¹„ìœ¨ ìœ ì§€í•˜ë©° ë¦¬ì‚¬ì´ì¦ˆ
            if (width > height) {
                if (width > maxDimension) {
                    height *= maxDimension / width;
                    width = maxDimension;
                }
            } else {
                if (height > maxDimension) {
                    width *= maxDimension / height;
                    height = maxDimension;
                }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            // canvas â†’ Blob ë³€í™˜
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append("file", blob, file.name); // ì´ë¦„ ìœ ì§€
                formData.append("roomId", roomId);

                fetch("/api/chat/image", {
                    method: "POST",
                    body: formData
                })
                    .then(res => res.text())
                    .then(imageUrl => {
                        fileInput.value = "";
                        console.log("âœ… ë¦¬ì‚¬ì´ì¦ˆ í›„ ì—…ë¡œë“œ ì™„ë£Œ:", imageUrl);
                    })
                    .catch(err => {
                        console.error("âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨", err);
                        alert("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    });
            }, "image/jpeg", 0.9); // í’ˆì§ˆ ì¡°ì • (0.0 ~ 1.0)
        };
    }
</script>
<script>
    function scrollToBottomWhenImagesLoaded() {
        const chatBox = document.getElementById("chatBox");
        const images = chatBox.querySelectorAll("img");
        let loaded = 0;

        if (images.length === 0) {
            chatBox.scrollTop = chatBox.scrollHeight;
            return;
        }

        images.forEach(img => {
            if (img.complete) {
                loaded++;
                if (loaded === images.length) {
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } else {
                img.onload = () => {
                    loaded++;
                    if (loaded === images.length) {
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                };
            }
        });
        chatBox.scrollTo({
            top: chatBox.scrollHeight,
            behavior: "smooth"
        });
    }
</script>
</body>
</html>
